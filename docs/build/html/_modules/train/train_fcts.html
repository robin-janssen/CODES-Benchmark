<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>train.train_fcts &#8212; CODES Benchmark 09.09.2024 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=c058f7c8" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=47c521fd"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for train.train_fcts</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">benchmark.bench_utils</span> <span class="kn">import</span> <span class="n">get_model_config</span><span class="p">,</span> <span class="n">get_surrogate</span>
<span class="kn">from</span> <span class="nn">data</span> <span class="kn">import</span> <span class="n">check_and_load_data</span><span class="p">,</span> <span class="n">get_data_subset</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_progress_bar</span><span class="p">,</span>
    <span class="n">load_and_save_config</span><span class="p">,</span>
    <span class="n">make_description</span><span class="p">,</span>
    <span class="n">save_task_list</span><span class="p">,</span>
    <span class="n">set_random_seeds</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="train_and_save_model">
<a class="viewcode-back" href="../../index.html#train.train_and_save_model">[docs]</a>
<span class="k">def</span> <span class="nf">train_and_save_model</span><span class="p">(</span>
    <span class="n">surr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">metric</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">training_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
    <span class="n">position</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train and save a model for a specific benchmark mode. The parameters are determined</span>
<span class="sd">    by the task(s) which is created from the config file.</span>

<span class="sd">    Args:</span>
<span class="sd">        surr_name (str): The name of the surrogate model.</span>
<span class="sd">        mode (str): The benchmark mode (e.g. &quot;main&quot;, &quot;interpolation&quot;, &quot;extrapolation&quot;).</span>
<span class="sd">        metric (int): The metric for the benchmark mode.</span>
<span class="sd">        training_id (str): The training ID for the current training session.</span>
<span class="sd">        seed (int, optional): The random seed for the training. Defaults to None.</span>
<span class="sd">        epochs (int, optional): The number of epochs for the training. Defaults to None.</span>
<span class="sd">        device (str, optional): The device for the training. Defaults to &quot;cpu&quot;.</span>
<span class="sd">        position (int, optional): The position of the model in the task list. Defaults to 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;trained/</span><span class="si">{</span><span class="n">training_id</span><span class="si">}</span><span class="s2">/config.yaml&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">load_and_save_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Set the seed for the training</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_random_seeds</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># Load full data</span>
    <span class="n">full_train_data</span><span class="p">,</span> <span class="n">full_test_data</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">data_params</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">check_and_load_data</span><span class="p">(</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">log</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">][</span><span class="s2">&quot;log10_transform&quot;</span><span class="p">],</span>
            <span class="n">normalisation_mode</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">][</span><span class="s2">&quot;normalise&quot;</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">get_model_config</span><span class="p">(</span><span class="n">surr_name</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

    <span class="c1"># Get the appropriate data subset</span>
    <span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">timesteps</span> <span class="o">=</span> <span class="n">get_data_subset</span><span class="p">(</span>
        <span class="n">full_train_data</span><span class="p">,</span> <span class="n">full_test_data</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">metric</span>
    <span class="p">)</span>

    <span class="n">n_timesteps</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n_chemicals</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Get the surrogate class</span>
    <span class="n">surrogate_class</span> <span class="o">=</span> <span class="n">get_surrogate</span><span class="p">(</span><span class="n">surr_name</span><span class="p">)</span>

    <span class="c1"># Set the device for the model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">surrogate_class</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">n_chemicals</span><span class="p">,</span> <span class="n">n_timesteps</span><span class="p">,</span> <span class="n">model_config</span><span class="p">)</span>
    <span class="n">surr_idx</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;surrogates&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">surr_name</span><span class="p">)</span>

    <span class="c1"># Determine the batch size</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;surrogates&quot;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The number of provided batch sizes must match the number of surrogate models.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">][</span><span class="n">surr_idx</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">metric</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;batch_size&quot;</span> <span class="k">else</span> <span class="n">batch_size</span>
    <span class="c1"># epochs = epochs if epochs is not None else config[&quot;epochs&quot;]</span>

    <span class="n">train_loader</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">(</span>
        <span class="n">dataset_train</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span>
        <span class="n">dataset_test</span><span class="o">=</span><span class="n">test_data</span><span class="p">,</span>
        <span class="n">dataset_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timesteps</span><span class="o">=</span><span class="n">timesteps</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">description</span> <span class="o">=</span> <span class="n">make_description</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="n">surr_name</span><span class="p">)</span>

    <span class="c1"># Train the model</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">train_loader</span><span class="o">=</span><span class="n">train_loader</span><span class="p">,</span>
        <span class="n">test_loader</span><span class="o">=</span><span class="n">test_loader</span><span class="p">,</span>
        <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
        <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Save the model (making the name lowercase and removing any underscores)</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">surr_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
        <span class="n">training_id</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;training_id&quot;</span><span class="p">],</span>
        <span class="n">subfolder</span><span class="o">=</span><span class="s2">&quot;trained&quot;</span><span class="p">,</span>
        <span class="n">data_params</span><span class="o">=</span><span class="n">data_params</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="create_task_list_for_surrogate">
<a class="viewcode-back" href="../../index.html#train.create_task_list_for_surrogate">[docs]</a>
<span class="k">def</span> <span class="nf">create_task_list_for_surrogate</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">surr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a list of training tasks for a specific surrogate model based on the</span>
<span class="sd">    configuration file.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (dict): The configuration dictionary taken from the config file.</span>
<span class="sd">        surr_name (str): The name of the surrogate model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of training tasks for the surrogate model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;seed&quot;</span><span class="p">]</span>
    <span class="n">surr_idx</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;surrogates&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">surr_name</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;training_id&quot;</span><span class="p">]</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">][</span><span class="n">surr_idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">surr_name</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">epochs</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;interpolation&quot;</span><span class="p">][</span><span class="s2">&quot;enabled&quot;</span><span class="p">]:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;interpolation&quot;</span>
        <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;interpolation&quot;</span><span class="p">][</span><span class="s2">&quot;intervals&quot;</span><span class="p">]:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">surr_name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">seed</span> <span class="o">+</span> <span class="n">interval</span><span class="p">,</span> <span class="n">epochs</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;extrapolation&quot;</span><span class="p">][</span><span class="s2">&quot;enabled&quot;</span><span class="p">]:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;extrapolation&quot;</span>
        <span class="k">for</span> <span class="n">cutoff</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;extrapolation&quot;</span><span class="p">][</span><span class="s2">&quot;cutoffs&quot;</span><span class="p">]:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">surr_name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">seed</span> <span class="o">+</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">epochs</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;sparse&quot;</span><span class="p">][</span><span class="s2">&quot;enabled&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;sparse&quot;</span><span class="p">][</span><span class="s2">&quot;factors&quot;</span><span class="p">]:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">surr_name</span><span class="p">,</span> <span class="s2">&quot;sparse&quot;</span><span class="p">,</span> <span class="n">factor</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">seed</span> <span class="o">+</span> <span class="n">factor</span><span class="p">,</span> <span class="n">epochs</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;uncertainty&quot;</span><span class="p">][</span><span class="s2">&quot;enabled&quot;</span><span class="p">]:</span>
        <span class="n">n_models</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;uncertainty&quot;</span><span class="p">][</span><span class="s2">&quot;ensemble_size&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_models</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">surr_name</span><span class="p">,</span> <span class="s2">&quot;UQ&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">seed</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">epochs</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_scaling&quot;</span><span class="p">][</span><span class="s2">&quot;enabled&quot;</span><span class="p">]:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;batchsize&quot;</span>
        <span class="k">for</span> <span class="n">bs</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_scaling&quot;</span><span class="p">][</span><span class="s2">&quot;sizes&quot;</span><span class="p">]:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">surr_name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">seed</span> <span class="o">+</span> <span class="n">bs</span><span class="p">,</span> <span class="n">epochs</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">tasks</span></div>



<span class="k">def</span> <span class="nf">worker</span><span class="p">(</span>
    <span class="n">task_queue</span><span class="p">:</span> <span class="n">Queue</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">device_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">overall_progress_bar</span><span class="p">:</span> <span class="n">tqdm</span><span class="p">,</span>
    <span class="n">task_list_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Worker function to process tasks from the task queue on the given device.</span>

<span class="sd">    Args:</span>
<span class="sd">        task_queue (Queue): The task queue containing the training tasks.</span>
<span class="sd">        device (str): The device to use for training.</span>
<span class="sd">        device_idx (int): The index of the device in the device list.</span>
<span class="sd">        overall_progress_bar (tqdm): The overall progress bar for the training.</span>
<span class="sd">        task_list_filepath (str): The filepath to the task list file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">task_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">task_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
            <span class="n">train_and_save_model</span><span class="p">(</span><span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="n">device_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">task_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="n">overall_progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Save the remaining tasks after completing each one</span>
            <span class="n">remaining_tasks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">task_queue</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span>
            <span class="n">save_task_list</span><span class="p">(</span><span class="n">remaining_tasks</span><span class="p">,</span> <span class="n">task_list_filepath</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception for task </span><span class="si">{</span><span class="n">task</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">task_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="n">overall_progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<div class="viewcode-block" id="parallel_training">
<a class="viewcode-back" href="../../index.html#train.parallel_training">[docs]</a>
<span class="k">def</span> <span class="nf">parallel_training</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">device_list</span><span class="p">,</span> <span class="n">task_list_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute the training tasks in parallel on multiple devices.</span>

<span class="sd">    Args:</span>
<span class="sd">        tasks (list): The list of training tasks.</span>
<span class="sd">        device_list (list): The list of devices to use for training.</span>
<span class="sd">        task_list_filepath (str): The filepath to the task list file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">task_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="c1"># Create the overall progress bar</span>
    <span class="n">overall_progress_bar</span> <span class="o">=</span> <span class="n">get_progress_bar</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">device</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">device_list</span><span class="p">):</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">task_queue</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">overall_progress_bar</span><span class="p">,</span> <span class="n">task_list_filepath</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="n">overall_progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">overall_progress_bar</span><span class="o">.</span><span class="n">format_dict</span><span class="p">[</span><span class="s2">&quot;elapsed&quot;</span><span class="p">]</span>

    <span class="c1"># Create a completion marker after all tasks are completed</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">task_list_filepath</span><span class="p">),</span> <span class="s2">&quot;completed.txt&quot;</span><span class="p">),</span>
        <span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Training completed&quot;</span><span class="p">)</span>

    <span class="c1"># Remove the task list file</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task_list_filepath</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">elapsed_time</span></div>



<div class="viewcode-block" id="sequential_training">
<a class="viewcode-back" href="../../index.html#train.sequential_training">[docs]</a>
<span class="k">def</span> <span class="nf">sequential_training</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">device_list</span><span class="p">,</span> <span class="n">task_list_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute the training tasks sequentially on a single device.</span>

<span class="sd">    Args:</span>
<span class="sd">        tasks (list): The list of training tasks.</span>
<span class="sd">        device_list (list): The list of devices to use for training.</span>
<span class="sd">        task_list_filepath (str): The filepath to the task list file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">overall_progress_bar</span> <span class="o">=</span> <span class="n">get_progress_bar</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
        <span class="n">train_and_save_model</span><span class="p">(</span><span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="n">device_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">overall_progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">remaining_tasks</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
        <span class="n">save_task_list</span><span class="p">(</span><span class="n">remaining_tasks</span><span class="p">,</span> <span class="n">task_list_filepath</span><span class="p">)</span>

    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">overall_progress_bar</span><span class="o">.</span><span class="n">format_dict</span><span class="p">[</span><span class="s2">&quot;elapsed&quot;</span><span class="p">]</span>
    <span class="n">overall_progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Create a completion marker after all tasks are completed</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">task_list_filepath</span><span class="p">),</span> <span class="s2">&quot;completed.txt&quot;</span><span class="p">),</span>
        <span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Training completed&quot;</span><span class="p">)</span>

    <span class="c1"># Remove the task list file</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task_list_filepath</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">elapsed_time</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">CODES Benchmark</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Robin Janssen, Immanuel Sulzer.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.0.2</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>